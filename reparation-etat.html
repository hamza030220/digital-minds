<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Green.tn - Réparation État</title>
    <link rel="stylesheet" href="green.css">
</head>
<body>
    <!-- Header -->
    <header>
        <div class="logo-nav-container">
            <div class="logo">
                <img src="image/ve.png" alt="Green.tn Logo">
            </div>
            <nav class="nav-left">
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="index.html#a-nos-velos">Nos vélos</a></li>
                    <li><a href="index.html#a-propos-de-nous">À propos de nous</a></li>
                    <li><a href="index.html#pricing">Tarifs</a></li>
                    <li><a href="index.html#contact">Contact</a></li>
                    <li><a href="reparation-etat.html">Réparation État</a></li>
                </ul>
            </nav>
        </div>
        <nav class="nav-right">
            <ul>
                <li><a href="#" class="login">Login</a></li>
                <li><a href="#" class="signin">Signin</a></li>
            </ul>
        </nav>
    </header>

    <!-- Main Content -->
    <main>
        <!-- Hero Section -->
        <section class="hero">
            <div class="hero-box">
                <h1>Réparation État</h1>
                <p>Suivez l'état des réparations de nos vélos en temps réel.</p>
            </div>
            <div class="hero-image">
                <img src="image/hero.png" alt="Réparation État Image">
            </div>
        </section>

        <!-- Réparation État Section -->
        <section class="reparation-section" id="reparation-etat">
            <h2>Vélos en Réparation</h2>
            
            <!-- Search Bar -->
            <div class="search-bar">
                <input type="text" placeholder="Rechercher un vélo par ID, type ou pièce..." id="search-input" oninput="searchBikes()">
                <button onclick="searchBikes()">Rechercher</button>
            </div>

            <!-- Filter Buttons -->
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="all">Tous</button>
                <button class="filter-btn" data-filter="en-cours">En cours</button>
                <button class="filter-btn" data-filter="en-attente-de-pièces">En attente de pièces</button>
            </div>

            <!-- Reparation Grid -->
            <div class="reparation-grid" id="reparation-grid">
                <!-- Repairs will be loaded dynamically -->
            </div>
        </section>
    </main>

    <!-- Modal for Stock Details -->
    <div class="modal" id="stock-modal">
        <div class="modal-content">
            <h3>Détails du Stock</h3>
            <div id="stock-details"></div>
            <button class="close-btn" onclick="closeModal('stock-modal')">Fermer</button>
        </div>
    </div>

    <!-- Modal for Repair Details -->
    <div class="details-modal" id="details-modal">
        <div class="details-modal-content">
            <h3>Détails de la Réparation</h3>
            <div id="repair-details"></div>
            <button class="close-btn" onclick="closeModal('details-modal')">Fermer</button>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="footer-content">
            <div class="footer-left">
                <div class="footer-logo">
                    <img src="image/ho.png" alt="Green.tn Logo">
                </div>
                <div class="social-icons">
                    <a href="https://instagram.com"><img src="image/insta.png" alt="Instagram"></a>
                    <a href="https://facebook.com"><img src="image/fb.png" alt="Facebook"></a>
                    <a href="https://twitter.com"><img src="image/x.png" alt="Twitter"></a>
                </div>
            </div>
            <div class="footer-section">
                <h3>Navigation</h3>
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="index.html#a-nos-velos">Nos vélos</a></li>
                    <li><a href="index.html#a-propos-de-nous">À propos de nous</a></li>
                    <li><a href="index.html#pricing">Tarifs</a></li>
                    <li><a href="index.html#contact">Contact</a></li>
                    <li><a href="reparation-etat.html">Réparation État</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h3>Contact</h3>
                <p><img src="image/location.png" alt="Location Icon"> Eprit technopole</p>
                <p><img src="image/telephone.png" alt="Phone Icon"> +216245678</p>
                <p><img src="image/mail.png" alt="Email Icon"> <a href="mailto:Green@green.com">Green@green.com</a></p>
            </div>
        </div>
    </footer>

    <script>
    let allRepairs = [];

    function escapeHTML(str) {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    function fetchRepairs() {
        fetch('api/get_repairs.php')
            .then(response => {
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return response.json();
            })
            .then(data => {
                allRepairs = data;
                renderRepairs(allRepairs);
            })
            .catch(error => {
                console.error('Error fetching repairs:', error);
                alert('Erreur lors du chargement des réparations: ' + error.message);
            });
    }

    function renderRepairs(repairs) {
        const grid = document.getElementById('reparation-grid');
        grid.innerHTML = '';

        const bikeImages = {
            'Vélo de Ville': 'image/vv.jpg',
            'Vélo de Course': 'image/co.jpg',
            'Vélo de Montagne': 'image/mm.jpg'
        };

        repairs.forEach(repair => {
            const statusClass = repair.status.toLowerCase().replace(' ', '-') || 'en-cours';
            const bikeImage = bikeImages[repair.bike_type] || 'image/vv.jpg';
            const estimatedDate = calculateEstimatedDate(repair.status, repair.progression);

            const card = document.createElement('div');
            card.className = `reparation-card`;
            card.setAttribute('data-status', statusClass);
            card.innerHTML = `
                <img src="${bikeImage}" alt="${escapeHTML(repair.bike_type)}" class="bike-image">
                <h3>${escapeHTML(repair.bike_type)} #${escapeHTML(repair.bike_id)}</h3>
                <p>Pièce: ${escapeHTML(repair.stock_item_name || 'Aucune')}</p>
                <p class="status ${statusClass}">État: ${escapeHTML(repair.status)}</p>
                <div class="progress-bar">
                    <div class="progress" style="width: ${repair.progression}%;"></div>
                </div>
                <p>Date estimée: ${estimatedDate}</p>
                <button class="detail" onclick='showRepairDetails(${JSON.stringify(repair)})'>Voir Détails</button>
                <button class="stock-btn" onclick="showStockDetails(${repair.stock_id || 0})" ${!repair.stock_id ? 'disabled' : ''}>
                    Voir le stock
                </button>
            `;
            grid.appendChild(card);
        });
    }

    function calculateEstimatedDate(status, progression) {
        const baseDate = new Date('2025-04-17');
        let daysToAdd;

        if (status === 'En cours') {
            daysToAdd = Math.round((100 - progression) / 10);
        } else {
            daysToAdd = 11;
        }

        baseDate.setDate(baseDate.getDate() + daysToAdd);
        return baseDate.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
    }

    function showStockDetails(stockId) {
        console.log('Stock ID:', stockId);
        if (!stockId || stockId === 0) {
            alert('Aucune pièce associée à cette réparation');
            return;
        }
        fetch('api/get_stock.php')
            .then(response => {
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return response.json();
            })
            .then(data => {
                console.log('Stock Data:', data);
                const stockItem = data.find(item => item.id == stockId);
                console.log('Found Stock Item:', stockItem);
                if (!stockItem) {
                    alert('Pièce non trouvée dans le stock');
                    return;
                }
                // Ensure price is a number before calling toFixed
                const price = parseFloat(stockItem.price);
                if (isNaN(price)) {
                    throw new Error('Price is not a valid number');
                }
                const modal = document.getElementById('stock-modal');
                const stockDetails = document.getElementById('stock-details');
                stockDetails.innerHTML = `
                    <p><strong>Pièce:</strong> ${escapeHTML(stockItem.item_name)}</p>
                    <p><strong>Catégorie:</strong> ${escapeHTML(stockItem.category)}</p>
                    <p><strong>Quantité en stock:</strong> ${stockItem.quantity}</p>
                    <p><strong>Prix:</strong> ${price.toFixed(2)} TND</p>
                `;
                modal.style.display = 'flex';
            })
            .catch(error => {
                console.error('Error fetching stock details:', error);
                alert('Erreur lors du chargement des détails du stock: ' + error.message);
            });
    }

    function showRepairDetails(repair) {
        const modal = document.getElementById('details-modal');
        const repairDetails = document.getElementById('repair-details');
        const estimatedDate = calculateEstimatedDate(repair.status, repair.progression);
        repairDetails.innerHTML = `
            <p><strong>ID du Vélo:</strong> ${escapeHTML(repair.bike_id)}</p>
            <p><strong>Type de Vélo:</strong> ${escapeHTML(repair.bike_type)}</p>
            <p><strong>Pièce:</strong> ${escapeHTML(repair.stock_item_name || 'Aucune')}</p>
            <p><strong>État:</strong> ${escapeHTML(repair.status)}</p>
            <p><strong>Progression:</strong> ${repair.progression}%</p>
            <p><strong>Date Estimée:</strong> ${estimatedDate}</p>
        `;
        modal.style.display = 'flex';
    }

    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        modal.style.display = 'none';
    }

    // Close modals when clicking outside the modal content
    document.querySelectorAll('.modal, .details-modal').forEach(modal => {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });
    });

    function searchBikes() {
        const searchInput = document.getElementById('search-input').value.toLowerCase();
        const filteredRepairs = allRepairs.filter(repair => 
            repair.bike_id.toLowerCase().includes(searchInput) || 
            repair.bike_type.toLowerCase().includes(searchInput) ||
            (repair.stock_item_name && repair.stock_item_name.toLowerCase().includes(searchInput))
        );
        renderRepairs(filteredRepairs);
    }

    document.querySelectorAll('.filter-btn').forEach(button => {
        button.addEventListener('click', () => {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');

            const filter = button.getAttribute('data-filter');
            let filteredRepairs = allRepairs;

            if (filter !== 'all') {
                const statusFilter = filter === 'en-cours' ? 'En cours' : 'En attente de pièces';
                filteredRepairs = allRepairs.filter(repair => repair.status === statusFilter);
            }

            renderRepairs(filteredRepairs);
        });
    });

    fetchRepairs();
    </script>
</body>
</html>