<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Green.tn - Réparation État</title>
    <link rel="stylesheet" href="green.css"> <!-- External CSS, if still used -->
    <!-- Embedded CSS to fix stock image size -->
    <style>
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: #fff;
            padding: 25px;
            border-radius: 8px;
            max-width: 350px; /* Compact modal width */
            width: 90%;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            text-align: center;
            overflow: hidden; /* Clip any overflow */
            max-height: 80vh; /* Limit height to viewport */
        }

        .modal-content h3 {
            margin-top: 0;
            color: #2e7d32; /* Green */
            font-size: 1.5em;
        }

        .modal-content p {
            margin: 10px 0;
            font-size: 16px;
        }

        /* Bike Image (unchanged, assumed working) */
        .modal-bike-image {
            max-width: 180px;
            max-height: 180px;
            height: auto;
            border-radius: 8px;
            margin-bottom: 15px;
            display: block;
            margin-left: auto;
            margin-right: auto;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        /* Stock Item Image (adjusted to fix size) */
        .modal-stock-image {
            width: 100%;
            max-width: 150px; /* Strict cap to prevent overflow */
            max-height: 150px;
            height: auto;
            border-radius: 8px;
            margin-bottom: 15px;
            display: block;
            margin-left: auto;
            margin-right: auto;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .close-btn {
            background-color: #2e7d32; /* Green */
            color: #fff;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            font-size: 14px;
        }

        .close-btn:hover {
            background-color: #4CAF50; /* Lighter green */
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="logo-nav-container">
            <div class="logo">
                <img src="images/ve.png" alt="Green.tn Logo">
            </div>
            <nav class="nav-left">
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="index.html#a-nos-velos">Nos vélos</a></li>
                    <li><a href="index.html#a-propos-de-nous">À propos de nous</a></li>
                    <li><a href="index.html#pricing">Tarifs</a></li>
                    <li><a href="index.html#contact">Contact</a></li>
                    <li><a href="reparation-etat.html">Réparation État</a></li>
                </ul>
            </nav>
        </div>
        <nav class="nav-right">
            <ul>
                <li><a href="#" class="login">Login</a></li>
                <li><a href="#" class="signin">Signin</a></li>
                <li>
                    <select id="language-selector" onchange="changeLanguage()">
                        <option value="fr">Français</option>
                        <option value="en">English</option>
                    </select>
                </li>
            </ul>
        </nav>
    </header>

    <!-- Main Content -->
    <main>
        <!-- Hero Section -->
        <section class="hero">
            <div class="hero-box">
                <h1>Réparation État</h1>
                <p>Suivez l'état des réparations de nos vélos en temps réel.</p>
            </div>
            <div class="hero-image">
                <img src="images/hero.png" alt="Réparation État Image">
            </div>
        </section>

        <!-- Réparation État Section -->
        <section class="reparation-section" id="reparation-etat">
            <h2>Vélos en Réparation</h2>
            
            <!-- Search Bar -->
            <div class="search-bar">
                <input type="text" placeholder="Rechercher un vélo par ID, type ou pièce..." id="search-input" oninput="searchBikes()">
                <button onclick="searchBikes()">Rechercher</button>
            </div>

            <!-- Filter Buttons -->
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="all">Tous</button>
                <button class="filter-btn" data-filter="en-cours">En cours</button>
                <button class="filter-btn" data-filter="en-attente-de-pièces">En attente de pièces</button>
            </div>

            <!-- Reparation Grid -->
            <div class="reparation-grid" id="reparation-grid">
                <!-- Repairs will be loaded dynamically -->
            </div>
        </section>
    </main>

    <!-- Modal for Stock Details -->
    <div class="modal" id="stock-modal">
        <div class="modal-content">
            <h3>Détails du Stock</h3>
            <div id="stock-details"></div>
            <button class="close-btn" onclick="closeModal('stock-modal')">Fermer</button>
        </div>
    </div>

   <!-- Modal for Repair Details -->
<div class="modal" id="details-modal">
    <div class="modal-content">
        <h3 data-translate="repair_modal_title">Détails de la Réparation</h3>
        <div id="repair-details"></div>
        <div id="review-form" style="display: none;">
            <p data-translate="review_label">Évaluer cette réparation</p>
            <div class="star-rating">
                <span class="star" data-value="1" role="button" aria-label="1 star">★</span>
                <span class="star" data-value="2" role="button" aria-label="2 stars">★</span>
                <span class="star" data-value="3" role="button" aria-label="3 stars">★</span>
                <span class="star" data-value="4" role="button" aria-label="4 stars">★</span>
                <span class="star" data-value="5" role="button" aria-label="5 stars">★</span>
            </div>
            <p class="rating-display" id="rating-display"></p>
            <button class="close-btn" onclick="submitReview()" data-translate="review_submit">Soumettre l'évaluation</button>
        </div>
        <p id="review-average" style="display: none;" data-translate="review_average">Évaluation moyenne: <span></span></p>
        <button class="close-btn" onclick="closeModal('details-modal')" data-translate="close_button">Fermer</button>
    </div>
</div>

    <!-- Footer -->
    <footer>
        <div class="footer-content">
            <div class="footer-left">
                <div class="footer-logo">
                    <img src="images/ho.png" alt="Green.tn Logo">
                </div>
                <div class="social-icons">
                    <a href="https://instagram.com"><img src="images/insta.png" alt="Instagram"></a>
                    <a href="https://facebook.com"><img src="images/fb.png" alt="Facebook"></a>
                    <a href="https://twitter.com"><img src="images/x.png" alt="Twitter"></a>
                </div>
            </div>
            <div class="footer-section">
                <h3>Navigation</h3>
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="index.html#a-nos-velos">Nos vélos</a></li>
                    <li><a href="index.html#a-propos-de-nous">À propos de nous</a></li>
                    <li><a href="index.html#pricing">Tarifs</a></li>
                    <li><a href="index.html#contact">Contact</a></li>
                    <li><a href="reparation-etat.html">Réparation État</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h3>Contact</h3>
                <p><img src="images/location.png" alt="Location Icon"> Eprit technopole</p>
                <p><img src="images/telephone.png" alt="Phone Icon"> +216245678</p>
                <p><img src="images/mail.png" alt="Email Icon"> <a href="mailto:Green@green.com">Green@green.com</a></p>
            </div>
        </div>
    </footer>

    <script>
 let allRepairs = [];
let translations = {};
let currentLanguage = localStorage.getItem('language') || 'fr';
let selectedRating = 0;
let currentRepairId = null;

function escapeHTML(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

// Load translations
function loadTranslations(lang) {
    fetch(`translations/${lang}.json`)
        .then(response => {
            if (!response.ok) throw new Error('Failed to load translations');
            return response.json();
        })
        .then(data => {
            translations[lang] = data;
            updateUIText();
        })
        .catch(error => {
            console.error('Error loading translations:', error);
            alert('Erreur lors du chargement des traductions');
        });
}

// Update UI with translations
function updateUIText() {
    document.querySelectorAll('[data-translate]').forEach(element => {
        const key = element.getAttribute('data-translate');
        element.textContent = translations[currentLanguage][key] || element.textContent;
    });
    document.title = translations[currentLanguage].page_title;
    document.querySelector('#search-input').placeholder = translations[currentLanguage].search_placeholder;
    document.querySelectorAll('.filter-btn').forEach(btn => {
        const filter = btn.getAttribute('data-filter');
        const filterKeyMap = {
            'all': 'filter_all',
            'en-cours': 'filter_in_progress',
            'en-attente-de-pièces': 'filter_waiting'
        };
        btn.textContent = translations[currentLanguage][filterKeyMap[filter]] || btn.textContent;
    });
    renderRepairs(allRepairs); // Re-render to update dynamic text
}

// Change language
function changeLanguage() {
    currentLanguage = document.getElementById('language-selector').value;
    localStorage.setItem('language', currentLanguage);
    loadTranslations(currentLanguage);
}

function fetchRepairs() {
    fetch('api/get_repairs.php')
        .then(response => {
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            return response.json();
        })
        .then(data => {
            allRepairs = data;
            renderRepairs(allRepairs);
        })
        .catch(error => {
            console.error('Error fetching repairs:', error);
            alert(translations[currentLanguage].error_loading_repairs + ': ' + error.message);
        });
}

function renderRepairs(repairs) {
    const grid = document.getElementById('reparation-grid');
    grid.innerHTML = '';

    const bikeImages = {
        'Vélo de Ville': 'images/vv.jpg',
        'Vélo de Course': 'images/co.jpg',
        'Vélo de Montagne': 'images/mm.jpg'
    };

    repairs.forEach(repair => {
        const statusClass = repair.status.toLowerCase().replace(' ', '-') || 'en-cours';
        const bikeImage = bikeImages[repair.bike_type] || 'images/vv.jpg';
        const estimatedDate = calculateEstimatedDate(repair.status, repair.progression);
        const averageRating = repair.average_rating ? `${parseFloat(repair.average_rating).toFixed(1)} ★` : '';

        const card = document.createElement('div');
        card.className = `reparation-card`;
        card.setAttribute('data-status', statusClass);
        card.innerHTML = `
            <img src="${bikeImage}" alt="${escapeHTML(repair.bike_type)}" class="bike-image">
            <h3>${escapeHTML(repair.bike_type)} #${escapeHTML(repair.bike_id)}</h3>
            <p>${translations[currentLanguage].repair_card_piece}: ${escapeHTML(repair.stock_item_name || translations[currentLanguage].no_stock)}</p>
            <p class="status ${statusClass}">${translations[currentLanguage].repair_card_status}: ${escapeHTML(repair.status)}</p>
            <div class="progress-bar">
                <div class="progress" style="width: ${repair.progression}%;"></div>
            </div>
            <p>${translations[currentLanguage].repair_card_date}: ${estimatedDate}</p>
            ${repair.progression == 100 && averageRating ? `<p>${translations[currentLanguage].review_average}: ${averageRating}</p>` : ''}
            <button class="detail" onclick='showRepairDetails(${JSON.stringify(repair)})'>${translations[currentLanguage].repair_card_details}</button>
            <button class="stock-btn" onclick="showStockDetails(${repair.stock_id || 0})" ${!repair.stock_id ? 'disabled' : ''}>
                ${translations[currentLanguage].repair_card_stock}
            </button>
        `;
        grid.appendChild(card);
    });
}

function calculateEstimatedDate(status, progression) {
    const baseDate = new Date('2025-04-17');
    let daysToAdd;

    if (status === 'En cours') {
        daysToAdd = Math.round((100 - progression) / 10);
    } else {
        daysToAdd = 11;
    }

    baseDate.setDate(baseDate.getDate() + daysToAdd);
    return baseDate.toLocaleDateString(currentLanguage === 'fr' ? 'fr-FR' : 'en-US', { day: '2-digit', month: '2-digit', year: 'numeric' });
}

function showStockDetails(stockId) {
    if (!stockId || stockId === 0) {
        alert(translations[currentLanguage].error_no_stock);
        return;
    }
    fetch('api/get_stock.php')
        .then(response => {
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            return response.json();
        })
        .then(data => {
            const stockItem = data.find(item => item.id == stockId);
            if (!stockItem) {
                alert(translations[currentLanguage].error_stock_not_found);
                return;
            }
            const price = parseFloat(stockItem.price);
            if (isNaN(price)) {
                throw new Error('Price is not a valid number');
            }
            const stockImages = {
                'Freins': 'images/freins.jpg',
                'Helmet': 'images/helmet.jpg',
                'Chain': 'images/chain.jpg'
            };
            const stockImage = stockImages[stockItem.item_name] || 'image/placeholder.jpg';

            const modal = document.getElementById('stock-modal');
            const stockDetails = document.getElementById('stock-details');
            stockDetails.innerHTML = `
                <img src="${stockImage}" alt="${escapeHTML(stockItem.item_name)}" class="modal-stock-image">
                <p><strong>${translations[currentLanguage].stock_piece}:</strong> ${escapeHTML(stockItem.item_name)}</p>
                <p><strong>${translations[currentLanguage].stock_category}:</strong> ${escapeHTML(stockItem.category)}</p>
                <p><strong>${translations[currentLanguage].stock_quantity}:</strong> ${stockItem.quantity}</p>
                <p><strong>${translations[currentLanguage].stock_price}:</strong> ${price.toFixed(2)} TND</p>
            `;
            modal.style.display = 'flex';
            updateUIText(); // Ensure modal text is translated
        })
        .catch(error => {
            console.error('Error fetching stock details:', error);
            alert(translations[currentLanguage].error_loading_stock + ': ' + error.message);
        });
}

function showRepairDetails(repair) {
    currentRepairId = repair.id;
    const modal = document.getElementById('details-modal');
    const repairDetails = document.getElementById('repair-details');
    const reviewForm = document.getElementById('review-form');
    const reviewAverage = document.getElementById('review-average');
    const estimatedDate = calculateEstimatedDate(repair.status, repair.progression);
    const bikeImages = {
        'Vélo de Ville': 'images/vv.jpg',
        'Vélo de Course': 'images/co.jpg',
        'Vélo de Montagne': 'images/mm.jpg'
    };
    const bikeImage = bikeImages[repair.bike_type] || 'images/vv.jpg';

    repairDetails.innerHTML = `
        <img src="${bikeImage}" alt="${escapeHTML(repair.bike_type)}" class="modal-bike-image">
        <p><strong>${translations[currentLanguage].repair_bike_id}:</strong> ${escapeHTML(repair.bike_id)}</p>
        <p><strong>${translations[currentLanguage].repair_bike_type}:</strong> ${escapeHTML(repair.bike_type)}</p>
        <p><strong>${translations[currentLanguage].repair_piece}:</strong> ${escapeHTML(repair.stock_item_name || translations[currentLanguage].no_stock)}</p>
        <p><strong>${translations[currentLanguage].repair_status}:</strong> ${escapeHTML(repair.status)}</p>
        <p><strong>${translations[currentLanguage].repair_progress}:</strong> ${repair.progression}%</p>
        <p><strong>${translations[currentLanguage].repair_date}:</strong> ${estimatedDate}</p>
    `;

    // Show review form for completed repairs
    if (repair.progression == 100) {
        reviewForm.style.display = 'block';
        resetStarRating();
        // Fetch and display average rating
        fetch(`api/get_repair_rating.php?repair_id=${repair.id}`)
            .then(response => response.json())
            .then(data => {
                if (data.average_rating) {
                    reviewAverage.style.display = 'block';
                    reviewAverage.querySelector('span').textContent = `${parseFloat(data.average_rating).toFixed(1)} ★`;
                } else {
                    reviewAverage.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error fetching rating:', error);
            });
    } else {
        reviewForm.style.display = 'none';
        reviewAverage.style.display = 'none';
    }

    modal.style.display = 'flex';
    updateUIText(); // Ensure modal text is translated
}

function resetStarRating() {
    selectedRating = 0;
    const ratingDisplay = document.getElementById('rating-display');
    ratingDisplay.textContent = '';

    document.querySelectorAll('.star').forEach(star => {
        star.classList.remove('selected');
        star.tabIndex = 0; // Make stars focusable for keyboard access

        // Click handler
        star.addEventListener('click', () => {
            selectedRating = parseInt(star.getAttribute('data-value'));
            updateStarSelection();
        });

        // Hover handler
        star.addEventListener('mouseover', () => {
            const value = parseInt(star.getAttribute('data-value'));
            document.querySelectorAll('.star').forEach(s => {
                s.classList.remove('selected');
                if (parseInt(s.getAttribute('data-value')) <= value) {
                    s.classList.add('selected');
                }
            });
        });

        // Reset on mouseout
        star.addEventListener('mouseout', () => {
            updateStarSelection();
        });

        // Keyboard support
        star.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                selectedRating = parseInt(star.getAttribute('data-value'));
                updateStarSelection();
            } else if (e.key === 'ArrowLeft' && selectedRating > 1) {
                selectedRating--;
                updateStarSelection();
                document.querySelector(`.star[data-value="${selectedRating}"]`).focus();
            } else if (e.key === 'ArrowRight' && selectedRating < 5) {
                selectedRating++;
                updateStarSelection();
                document.querySelector(`.star[data-value="${selectedRating}"]`).focus();
            }
        });
    });

    // Update star selection and display
    function updateStarSelection() {
        document.querySelectorAll('.star').forEach(s => {
            s.classList.remove('selected');
            if (parseInt(s.getAttribute('data-value')) <= selectedRating) {
                s.classList.add('selected');
            }
        });
        ratingDisplay.textContent = selectedRating ? `${selectedRating} ${selectedRating === 1 ? (currentLanguage === 'fr' ? 'étoile' : 'star') : (currentLanguage === 'fr' ? 'étoiles' : 'stars')}` : '';
    }
}

function submitReview() {
    if (!selectedRating) {
        alert(translations[currentLanguage].review_error + ': ' + (currentLanguage === 'fr' ? 'Veuillez sélectionner une note (1 à 5 étoiles)' : 'Please select a rating (1 to 5 stars)'));
        return;
    }

    fetch('api/submit_repair_rating.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ repair_id: currentRepairId, rating: selectedRating })
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                alert(translations[currentLanguage].review_thanks);
                document.getElementById('review-form').style.display = 'none';
                fetchRepairs(); // Refresh repairs to update average rating
            } else {
                alert(translations[currentLanguage].review_error + ': ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error submitting review:', error);
            alert(translations[currentLanguage].review_error + ': ' + error.message);
        });
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    modal.style.display = 'none';
}

document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.style.display = 'none';
        }
    });
});

function searchBikes() {
    const searchInput = document.getElementById('search-input').value.toLowerCase();
    const filteredRepairs = allRepairs.filter(repair => 
        repair.bike_id.toLowerCase().includes(searchInput) || 
        repair.bike_type.toLowerCase().includes(searchInput) ||
        (repair.stock_item_name && repair.stock_item_name.toLowerCase().includes(searchInput))
    );
    renderRepairs(filteredRepairs);
}

document.querySelectorAll('.filter-btn').forEach(button => {
    button.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');

        const filter = button.getAttribute('data-filter');
        let filteredRepairs = allRepairs;

        if (filter !== 'all') {
            const statusFilterMap = {
                'en-cours': currentLanguage === 'fr' ? 'En cours' : 'In Progress',
                'en-attente-de-pièces': currentLanguage === 'fr' ? 'En attente de pièces' : 'Waiting for Parts'
            };
            filteredRepairs = allRepairs.filter(repair => repair.status === statusFilterMap[filter]);
        }

        renderRepairs(filteredRepairs);
    });
});

// Initialize page
document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('language-selector').value = currentLanguage;
    loadTranslations(currentLanguage);
    fetchRepairs();
});
    
    </script>
</body>
</html>