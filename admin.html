<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Green.tn - Admin Dashboard</title>
    <link rel="stylesheet" href="admin.css">
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="logo">
            <img src="image/ve.png" alt="Green.tn Logo">
        </div>
        <nav class="sidebar-nav">
            <ul>
                <li><a href="#dashboard"><span class="icon">üìä</span> Dashboard</a></li>
                <li><a href="#bikes"><span class="icon">üö≤</span> Gestion des V√©los</a></li>
                <li><a href="#repairs" class="active"><span class="icon">üîß</span> R√©parations</a></li>
                <li><a href="#users"><span class="icon">üë•</span> Utilisateurs</a></li>
                <li><a href="#settings"><span class="icon">‚öôÔ∏è</span> Param√®tres</a></li>
            </ul>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Header -->
        <header class="admin-header">
            <h1>Admin Dashboard</h1>
            <div class="user-profile">
                <img src="image/face.jpg" alt="User Avatar" class="avatar">
                <span>Aziz miaoui</span>
            </div>
        </header>

        <!-- Dashboard Section -->
        <section class="dashboard" id="dashboard">
            <h2>Vue d'ensemble</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>10</h3>
                    <p>V√©los en R√©paration</p>
                </div>
                <div class="stat-card">
                    <h3>5</h3>
                    <p>R√©parations en Cours</p>
                </div>
                <div class="stat-card">
                    <h3>3</h3>
                    <p>R√©parations en Attente</p>
                </div>
                <div class="stat-card">
                    <h3>15</h3>
                    <p>R√©parations Termin√©es</p>
                </div>
            </div>
        </section>

        <!-- Bike Management Section -->
        <section class="management" id="bikes">
            <h2>Gestion des V√©los</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Type</th>
                            <th>Probl√®me</th>
                            <th>Statut</th>
                            <th>Progression</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>001</td>
                            <td>V√©lo de Ville</td>
                            <td>Pneu crev√©</td>
                            <td><span class="status en-cours">En cours</span></td>
                            <td>
                                <div class="progress-bar">
                                    <div class="progress" style="width: 50%;"></div>
                                </div>
                            </td>
                            <td>
                                <a href="#" class="btn edit">Modifier</a>
                                <a href="#" class="btn delete">Supprimer</a>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <a href="#" class="btn add">Ajouter un V√©lo</a>
        </section>

        <!-- Repairs Section -->
        <section class="management" id="repairs">
            <h2>R√©parations</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Type</th>
                            <th>Pi√®ce Utilis√©e</th>
                            <th>Statut</th>
                            <th>Progression</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="repairs-table-body"></tbody>
                </table>
            </div>
            <a href="#" class="btn add" onclick="addRepair()">Ajouter une R√©paration</a>
            <div id="add-form-container"></div>
        </section>
    </main>

    <script>
    let currentEditRow = null;
    let currentAddForm = null;
    let stockItems = [];

    // Function to escape HTML characters
    function escapeHTML(str) {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    // Fetch stock items
    function fetchStock(callback) {
        fetch('api/get_stock.php')
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(data => {
                stockItems = data;
                callback();
            })
            .catch(error => {
                console.error('Error fetching stock:', error);
                alert('Erreur lors du chargement des stocks');
            });
    }

    function fetchRepairs() {
        fetch('api/get_repairs.php')
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(data => {
                if (data.error) throw new Error(data.error);
                if (!Array.isArray(data)) throw new Error('Expected an array of repairs');
                const tbody = document.getElementById('repairs-table-body');
                tbody.innerHTML = '';
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6">Aucune r√©paration trouv√©e</td></tr>';
                    return;
                }
                data.forEach(repair => {
                    const row = document.createElement('tr');
                    const statusClass = repair.status.toLowerCase().replace(' ', '-') || 'en-cours';
                    const stockClass = repair.stock_quantity <= 0 ? 'low-stock' : '';
                    row.innerHTML = `
                        <td>${escapeHTML(repair.bike_id)}</td>
                        <td>${escapeHTML(repair.bike_type)}</td>
                        <td class="${stockClass}">${escapeHTML(repair.stock_item_name || 'Aucune')}</td>
                        <td><span class="status ${statusClass}">${escapeHTML(repair.status)}</span></td>
                        <td>
                            <div class="progress-bar">
                                <div class="progress" style="width: ${repair.progression}%;"></div>
                            </div>
                        </td>
                        <td>
                            <a href="#" class="btn edit" onclick="editRepair(${repair.id}, '${escapeHTML(repair.bike_id)}', '${escapeHTML(repair.bike_type)}', ${repair.stock_id || 0}, '${escapeHTML(repair.status)}', ${repair.progression}, this)">Modifier</a>
                            <a href="#" class="btn delete" onclick="deleteRepair(${repair.id})">Supprimer</a>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            })
            .catch(error => {
                console.error('Error fetching repairs:', error);
                alert(`Erreur lors du chargement des r√©parations: ${error.message}`);
                const tbody = document.getElementById('repairs-table-body');
                tbody.innerHTML = '<tr><td colspan="6">Erreur lors du chargement des donn√©es</td></tr>';
            });
    }

    function addRepair() {
        if (currentAddForm) {
            currentAddForm.remove();
            currentAddForm = null;
        }
        if (currentEditRow) {
            currentEditRow.remove();
            currentEditRow = null;
        }

        fetchStock(() => {
            const addFormContainer = document.getElementById('add-form-container');
            const addForm = document.createElement('div');
            addForm.className = 'add-form';
            addForm.innerHTML = `
                <div class="form-header">
                    <h3>Ajouter une R√©paration</h3>
                </div>
                <div class="form-body">
                    <label>ID V√©lo: <input type="text" id="addBikeId" placeholder="Ex: 001"></label>
                    <label>Type: <input type="text" id="addBikeType" placeholder="Ex: V√©lo de Ville"></label>
                    <label>Pi√®ce Utilis√©e: 
                        <select id="addStockId" class="stock-select" onchange="updateAddStatus()">
                            <option value="0" disabled selected>S√©lectionner une pi√®ce</option>
                            ${stockItems.map(item => `<option value="${item.id}" data-quantity="${item.quantity}">${escapeHTML(item.item_name)} (${item.category}, Stock: ${item.quantity})</option>`).join('')}
                        </select>
                    </label>
                    <label>Statut: 
                        <select id="addStatus">
                            <option value="En attente">En attente</option>
                        </select>
                    </label>
                    <label>Progression (%): <input type="number" id="addProgression" value="0" min="0" max="100"></label>
                </div>
                <div class="form-footer">
                    <button onclick="saveNewRepair()">Enregistrer</button>
                    <button onclick="cancelAdd()">Annuler</button>
                </div>
            `;
            addFormContainer.appendChild(addForm);
            currentAddForm = addForm;
        });
    }

    function updateAddStatus() {
        const stockSelect = document.getElementById('addStockId');
        const statusSelect = document.getElementById('addStatus');
        const selectedOption = stockSelect.options[stockSelect.selectedIndex];
        const quantity = selectedOption ? parseInt(selectedOption.getAttribute('data-quantity')) : 0;

        statusSelect.innerHTML = quantity > 0
            ? `
                <option value="En cours">En cours</option>
                <option value="Termin√©">Termin√©</option>
            `
            : `<option value="En attente">En attente</option>`;
    }

    function saveNewRepair() {
        const bikeId = document.getElementById('addBikeId').value.trim();
        const bikeType = document.getElementById('addBikeType').value.trim();
        const stockId = parseInt(document.getElementById('addStockId').value);
        const status = document.getElementById('addStatus').value;
        const progression = parseInt(document.getElementById('addProgression').value);

        if (!bikeId.match(/^[a-zA-Z0-9-]+$/)) {
            alert('L\'ID du v√©lo doit √™tre alphanum√©rique');
            return;
        }
        if (!bikeType || bikeType.length > 100) {
            alert('Le type de v√©lo est requis et doit √™tre inf√©rieur √† 100 caract√®res');
            return;
        }
        if (stockId === 0) {
            alert('Veuillez s√©lectionner une pi√®ce');
            return;
        }
        if (!['En cours', 'En attente', 'Termin√©'].includes(status)) {
            alert('Statut invalide');
            return;
        }
        if (isNaN(progression) || progression < 0 || progression > 100) {
            alert('La progression doit √™tre un nombre entre 0 et 100');
            return;
        }

        const data = { bike_id: bikeId, bike_type: bikeType, status, progression, stock_id: stockId };

        fetch('api/add_repair.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    currentAddForm.remove();
                    currentAddForm = null;
                    fetchRepairs();
                } else {
                    alert('Erreur: ' + (data.error || 'Ajout √©chou√©'));
                }
            })
            .catch(error => {
                console.error('Error adding repair:', error);
                alert(`Erreur lors de l'ajout: ${error.message}`);
            });
    }

    function cancelAdd() {
        if (currentAddForm) {
            currentAddForm.remove();
            currentAddForm = null;
        }
    }

    function editRepair(id, bikeId, bikeType, stockId, status, progression, button) {
        if (currentEditRow) {
            currentEditRow.remove();
            currentEditRow = null;
        }
        if (currentAddForm) {
            currentAddForm.remove();
            currentAddForm = null;
        }

        const parentRow = button.closest('tr');
        if (!parentRow) {
            console.error('Parent row not found');
            alert('Erreur: impossible de trouver la ligne parente');
            return;
        }

        fetchStock(() => {
            const editRow = document.createElement('tr');
            editRow.className = 'edit-tab';
            const selectedStock = stockItems.find(item => item.id == stockId) || { quantity: 0 };
            editRow.innerHTML = `
                <td colspan="6">
                    <div class="edit-form">
                        <div class="form-header">
                            <h3>Modifier la R√©paration</h3>
                        </div>
                        <div class="form-body">
                            <input type="hidden" id="editId" value="${id}">
                            <label>ID V√©lo: <input type="text" id="editBikeId" value="${escapeHTML(bikeId)}"></label>
                            <label>Type: <input type="text" id="editBikeType" value="${escapeHTML(bikeType)}"></label>
                            <label>Pi√®ce Utilis√©e: 
                                <select id="editStockId" class="stock-select" onchange="updateEditStatus()">
                                    <option value="0" disabled>S√©lectionner une pi√®ce</option>
                                    ${stockItems.map(item => `
                                        <option value="${item.id}" data-quantity="${item.quantity}" ${item.id == stockId ? 'selected' : ''}>
                                            ${escapeHTML(item.item_name)} (${item.category}, Stock: ${item.quantity})
                                        </option>
                                    `).join('')}
                                </select>
                            </label>
                            <label>Statut: 
                                <select id="editStatus">
                                    ${selectedStock.quantity > 0
                                        ? `
                                            <option value="En cours" ${status === 'En cours' ? 'selected' : ''}>En cours</option>
                                            <option value="Termin√©" ${status === 'Termin√©' ? 'selected' : ''}>Termin√©</option>
                                        `
                                        : `<option value="En attente" selected>En attente</option>`}
                                </select>
                            </label>
                            <label>Progression (%): <input type="number" id="editProgression" value="${progression}" min="0" max="100"></label>
                        </div>
                        <div class="form-footer">
                            <button onclick="saveRepair()">Enregistrer</button>
                            <button onclick="cancelEdit()">Annuler</button>
                        </div>
                    </div>
                </td>
            `;
            parentRow.after(editRow);
            currentEditRow = editRow;
        });
    }

    function updateEditStatus() {
        const stockSelect = document.getElementById('editStockId');
        const statusSelect = document.getElementById('editStatus');
        const selectedOption = stockSelect.options[stockSelect.selectedIndex];
        const quantity = selectedOption ? parseInt(selectedOption.getAttribute('data-quantity')) : 0;

        statusSelect.innerHTML = quantity > 0
            ? `
                <option value="En cours">En cours</option>
                <option value="Termin√©">Termin√©</option>
            `
            : `<option value="En attente">En attente</option>`;
    }

    function saveRepair() {
        const id = document.getElementById('editId').value;
        const bikeId = document.getElementById('editBikeId').value.trim();
        const bikeType = document.getElementById('editBikeType').value.trim();
        const stockId = parseInt(document.getElementById('editStockId').value);
        const status = document.getElementById('editStatus').value;
        const progression = parseInt(document.getElementById('editProgression').value);

        if (!bikeId.match(/^[a-zA-Z0-9-]+$/)) {
            alert('L\'ID du v√©lo doit √™tre alphanum√©rique');
            return;
        }
        if (!bikeType || bikeType.length > 100) {
            alert('Le type de v√©lo est requis et doit √™tre inf√©rieur √† 100 caract√®res');
            return;
        }
        if (stockId === 0) {
            alert('Veuillez s√©lectionner une pi√®ce');
            return;
        }
        if (!['En cours', 'En attente', 'Termin√©'].includes(status)) {
            alert('Statut invalide');
            return;
        }
        if (isNaN(progression) || progression < 0 || progression > 100) {
            alert('La progression doit √™tre un nombre entre 0 et 100');
            return;
        }

        const data = { id, bike_id: bikeId, bike_type: bikeType, status, progression, stock_id: stockId };

        fetch('api/update_repair.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    currentEditRow.remove();
                    currentEditRow = null;
                    fetchRepairs();
                } else {
                    alert('Erreur: ' + (data.error || 'Modification √©chou√©e'));
                }
            })
            .catch(error => {
                console.error('Error updating repair:', error);
                alert(`Erreur lors de la modification: ${error.message}`);
            });
    }

    function cancelEdit() {
        if (currentEditRow) {
            currentEditRow.remove();
            currentEditRow = null;
        }
    }

    function deleteRepair(id) {
        if (confirm('√ätes-vous s√ªr de vouloir supprimer cette r√©paration ?')) {
            fetch('api/delete_repair.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id })
            })
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        fetchRepairs();
                    } else {
                        alert('Erreur: ' + (data.error || 'Suppression √©chou√©e'));
                    }
                })
                .catch(error => {
                    console.error('Error deleting repair:', error);
                    alert(`Erreur lors de la suppression: ${error.message}`);
                });
        }
    }

    // Load repairs on page load
    fetchRepairs();
    </script>
</body>
</html>